name: Build the current implementation without deploying
on:
  workflow_dispatch:

jobs:
  build:
    name: Build the module
    strategy:
      matrix:
        build_target:
          - runs_on: ubuntu-22.04
            cache_dir: ~/.conan2
          - runs_on: ubuntu-22.04-arm
            cache_dir: ~/.conan2
          - runs_on: macos-14
            cache_dir: ~/.conan2
          - runs_on: macos-13
            cache_dir: ~/.conan2
          - runs_on: windows-latest
            cache_dir: C:\Users\runneradmin\.conan2
    runs-on: ${{ matrix.build_target.runs_on }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Windows 10 SDK
        if: runner.os == 'Windows'
        uses: GuillaumeFalourd/setup-windows10-sdk-action@v2.4
        with:
          sdk-version: 17763
      # Configure environment variables so MSBuild can find the installed SDK.
      # See publish.yml for detailed explanation of why this is necessary.
      - name: Configure SDK paths for MSBuild
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "WindowsSdkDir=C:\Program Files (x86)\Windows Kits\10\" >> $env:GITHUB_ENV
          echo "WindowsSDKVersion=10.0.17763.0\" >> $env:GITHUB_ENV
          echo "WindowsSDKLibVersion=10.0.17763.0\" >> $env:GITHUB_ENV
      - name: Restore cached libraries
        uses: actions/cache@v3
        with:
          path: ${{ matrix.build_target.cache_dir }}
          key: ${{ matrix.build_target.runs_on }}-conan-${{ hashFiles('**/conanfile.py') }}
          restore-keys: |
            ${{ matrix.build_target.runs_on }}-conan-
      - name: Setup and build
        run: |
          make setup
          make module.tar.gz
      - name: Store the module as a temporary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.build_target.runs_on }}-module-${{ github.sha }}
          path: ./module.tar.gz
